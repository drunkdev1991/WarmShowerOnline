<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>One-to-One Anonymous Warm Shower</title>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body x-data="warmShower()">
  <h1>One-to-One Anonymous Warm Shower</h1>

  <!-- CREATE SESSION BLOCK (Organizer) -->
  <div style="border:1px solid #999; padding:1rem; margin-bottom:1rem;" x-show="!sessionCode">
    <h2>Create New Session</h2>
    <button @click="createSession()">Create Session</button>
    <template x-if="createdSession.code">
      <p>
        <strong>Session Code:</strong> <span x-text="createdSession.code"></span>
      </p>
    </template>
  </div>

  <!-- JOIN SESSION BLOCK (Participants) -->
  <div style="border:1px solid #999; padding:1rem; margin-bottom:1rem;">
    <h2>Join Session</h2>
    <label>Session Code:</label>
    <input type="text" x-model="joinCode" placeholder="6-digit code">
    <br>
    <label>Display Name (optional):</label>
    <input type="text" x-model="displayName" placeholder="Alice, Bob, etc.">
    <br>
    <button @click="join()">Join Session</button>
  </div>

  <!-- MAIN UI (If joined) -->
  <div style="border:1px solid #999; padding:1rem;" x-show="joinedSession">
    <h2>Session: <span x-text="sessionCode"></span></h2>
    <h3>Your Participant ID: <span x-text="participantId"></span></h3>

    <div style="border:1px solid #ccc; padding:1rem; margin-bottom:1rem;">
      <h3>Participants</h3>
      <template x-for="(name, pid) in participants" :key="pid">
        <div x-show="pid !== participantId" style="margin-bottom:0.5rem;">
          <strong x-text="name"></strong>
          <template x-if="messagesSent[pid]">
            <span style="color: green; margin-left:1rem;">(Message sent)</span>
          </template>
          <template x-if="!messagesSent[pid]">
            <button @click="sendMessageTo(pid)">Send Warm Shower</button>
          </template>
        </div>
      </template>
    </div>

    <div style="border:1px solid #ccc; padding:1rem; margin-bottom:1rem;">
      <h3>Incoming Messages</h3>
      <template x-for="msg in incomingMessages" :key="msg.timestamp + msg.text">
        <div style="margin-bottom:0.5rem;">
          <strong>Anonymous:</strong>
          <span x-text="msg.text"></span>
        </div>
      </template>
    </div>

    <button style="background-color:red; color:white;" @click="endSession()">End Session</button>
  </div>

<script>
function warmShower() {
  return {
    // Data
    sessionCode: "",
    createdSession: {},
    joinCode: "",
    displayName: "",
    participantId: null,
    joinedSession: false,

    participants: {},      // { pid: "Name", ... }
    messagesSent: {},      // { pid: true/false }
    incomingMessages: [],  // messages we have received

    async createSession() {
      try {
        const res = await fetch('/api/session', { method: 'POST' });
        const data = await res.json();
        this.createdSession = data; // {code, expires_in_seconds}
        alert(`Session created! Code: ${data.code}`);
      } catch (err) {
        console.error(err);
      }
    },

    async join() {
      if (!this.joinCode) {
        alert("Enter a session code.");
        return;
      }
      try {
        // Join
        const joinRes = await fetch(`/api/session/${this.joinCode}/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ displayName: this.displayName })
        });
        if (!joinRes.ok) {
          alert("Session not found or expired.");
          return;
        }
        const joinData = await joinRes.json();
        this.participantId = joinData.participantId;

        this.sessionCode = this.joinCode;
        this.joinedSession = true;

        // Fetch participants
        await this.fetchParticipants();
        // Initialize messagesSent = false for each participant
        for (const pid in this.participants) {
          if (pid !== this.participantId) {
            this.messagesSent[pid] = false;
          }
        }
        // Start SSE
        this.startSSE();
      } catch (err) {
        console.error(err);
      }
    },

    async fetchParticipants() {
      try {
        const res = await fetch(`/api/session/${this.sessionCode}/participants`);
        if (!res.ok) {
          alert("Error fetching participants.");
          return;
        }
        const data = await res.json();
        this.participants = data.participants;
      } catch (err) {
        console.error(err);
      }
    },

    startSSE() {
      const evtSource = new EventSource(`/api/session/${this.sessionCode}/stream/${this.participantId}`);
      evtSource.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        // msg = { text, timestamp }
        // We do not have "from" because it's anonymous
        this.incomingMessages.push(msg);
      };
      evtSource.onerror = (err) => {
        console.warn("SSE error:", err);
      };
    },

    async sendMessageTo(targetPid) {
      if (this.messagesSent[targetPid]) {
        alert("You already messaged this participant.");
        return;
      }
      // Prompt user for message text
      const msgText = prompt("Type your warm shower message for " + this.participants[targetPid], "");
      if (!msgText) return;

      try {
        const res = await fetch(`/api/session/${this.sessionCode}/message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            from: this.participantId,
            to: targetPid,
            text: msgText
          })
        });
        if (!res.ok) {
          const errData = await res.json();
          alert("Error: " + (errData.error || "unknown"));
          return;
        }
        // Mark as sent
        this.messagesSent[targetPid] = true;
        alert("Message sent anonymously to " + this.participants[targetPid]);
      } catch (err) {
        console.error(err);
      }
    },

    async endSession() {
      // Optional endpoint
      const res = await fetch(`/api/session/${this.sessionCode}/end`, {
        method: 'POST'
      });
      if (!res.ok) {
        const errData = await res.json();
        alert("End session failed: " + (errData.error || 'unknown'));
        return;
      }
      alert("Session ended. All data purged.");
      window.location.reload();
    }
  }
}
</script>
</body>
</html>
